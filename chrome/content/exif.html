<html>

<body style="font-family: monospace">
<script>

const Cc = Components.classes;
const Ci = Components.interfaces;
const Cu = Components.utils;

Cu.import ('resource://shrunked/shrunked.jsm');

var sourceFile = Cc ["@mozilla.org/file/local;1"].createInstance (Ci.nsILocalFile);
sourceFile.initWithPath ('C:\\Users\\Geoff\\Pictures\\2434816280_cef556e731_o.jpg');
Exif.read (sourceFile);

var destFile = Cc ["@mozilla.org/file/local;1"].createInstance (Ci.nsILocalFile);
destFile.initWithPath ('C:\\Users\\Geoff\\desktop\\index.jpg');

function writeSection (bytes, offset) {
	var length = bytes.charCodeAt (offset + 2) * 256 + bytes.charCodeAt (offset + 3) + 2;
	writeHex (bytes.substring (offset, offset + length));
	return length;
}

function writeHex (bytes) {
	if (typeof bytes == 'string') {
		var line = 0;
		var lineNum = Math.floor (line / 16).toString (16) + (line % 16).toString (16);
		document.body.appendChild (document.createTextNode (lineNum + ' | '));
		line++;
		for (var i = 0; i < bytes.length; i++) {
			var b = bytes.charCodeAt (i);
			document.body.appendChild (document.createTextNode(' ' + Math.floor (b / 16).toString (16) + (b % 16).toString (16)));
			if (i % 16 == 15) {
				document.body.appendChild (document.createElement ('br'));
				lineNum = Math.floor (line / 16).toString (16) + (line % 16).toString (16);
				document.body.appendChild (document.createTextNode (lineNum + ' | '));
				line++;
			}
			if (i > 1500)
				break;
		}
	} else {
		for (var i = 0; i < bytes.length; i++) {
			document.body.appendChild (document.createTextNode(' ' + Math.floor (bytes [i] / 16).toString (16) + (bytes [i] % 16).toString (16)));
			if (i % 16 == 15)
				document.body.appendChild (document.createElement ('br'));
		}
	}
}
/*
Cu.import ('resource://shrunked/exif.jsm');
var sourceFile = Cc ["@mozilla.org/file/local;1"].createInstance (Ci.nsILocalFile);
sourceFile.initWithPath ('C:\\Users\\Geoff\\Pictures\\img_6360.jpg');

var istream = Components.classes ["@mozilla.org/network/file-input-stream;1"].  
	createInstance (Components.interfaces.nsIFileInputStream);  
istream.init (sourceFile, -1, -1, false);  
var bstream = Components.classes ["@mozilla.org/binaryinputstream;1"].  
	createInstance (Components.interfaces.nsIBinaryInputStream);  
bstream.setInputStream (istream);

var bytes = bstream.readBytes (14);
writeHex (bytes); document.write ('<hr />');
var bigEndian = bytes.charCodeAt (12) == 0x4d;
bytes = bstream.readBytes (bytes.charCodeAt (4) * 256 + bytes.charCodeAt (5));

var n1 = readSection (6);
var rotation = 0;
switch (n1 ['112'].value) {
case 8:
	rotation = 90;
case 3:
	rotation = 180;
case 6:
	rotation = 270;
}

delete n1 ['112'];
delete n1 ['11a'];
delete n1 ['11b'];
delete n1 ['128'];
delete n1 ['213'];
n1.length -= 5;

document.write (JSON.stringify (n1).replace (/\},/g, '},<br />'));
document.write ('<hr />');
var n2 = readSection (n1 [8769].value - 2);

n2 ['a002'].value = 375;
n2 ['a003'].value = 500;
n2 ['a210'].value = 1;

document.write (JSON.stringify (n2).replace (/\},/g, '},<br />'));
document.write ('<hr />');
var header = getHeader ();
//writeHex (header);
//writeSection (header, 2);

function readSection (index) {
	function readShort () {
		if (bigEndian) {
			var s = bytes.charCodeAt (index) * 256 + bytes.charCodeAt (index + 1);
		} else {
			var s = bytes.charCodeAt (index + 1) * 256 + bytes.charCodeAt (index);
		}
		index += 2;
		return s;
	}

	function readLong () {
		if (bigEndian) {
			var s =
				bytes.charCodeAt (index) * 0x1000000 +
				bytes.charCodeAt (index + 1) * 0x10000 +
				bytes.charCodeAt (index + 2) * 0x100 +
				bytes.charCodeAt (index + 3);
		} else {
			var s =
				bytes.charCodeAt (index + 3) * 0x1000000 +
				bytes.charCodeAt (index + 2) * 0x10000 +
				bytes.charCodeAt (index + 1) * 0x100 +
				bytes.charCodeAt (index);
		}
		index += 4;
		return s;
	}

	var itemCount = readShort();
	var n2 = {length: itemCount};
	for (var i = 0; i < itemCount; i++) {
		var code = readShort ().toString (16);
		var type = readShort ();
		var count = readLong ();
		var value = readLong ();
		n2 [code] = {
			type: type,
			count: count,
			value: value
		}
		switch (type) {
		case 2:
			var str = bytes.substring (value - 2, value + count - 3);
			n2 [code].str = str;
			break;
		case 5:
		case 10:
		case 12:
			var str = bytes.substring (value - 2, value + 6);
			n2 [code].str = str;
			break;
		}
	}
	return n2;
}

function getHeader () {
	function serializeShort (s, bigEndian) {
		if (bigEndian) {
			bytes.push ((s & 0xff00) >> 8);
			bytes.push (s & 0x00ff);
		} else {
			bytes.push (s & 0x00ff);
			bytes.push ((s & 0xff00) >> 8);
		}
	}

	function serializeLong (l, bigEndian) {
		if (bigEndian) {
			bytes.push ((l & 0xff000000) >> 24);
			bytes.push ((l & 0x00ff0000) >> 16);
			bytes.push ((l & 0x0000ff00) >> 8);
			bytes.push (l & 0x000000ff);
		} else {
			bytes.push (l & 0x000000ff);
			bytes.push ((l & 0x0000ff00) >> 8);
			bytes.push ((l & 0x00ff0000) >> 16);
			bytes.push ((l & 0xff000000) >> 24);
		}
	}

	function serializeAscii (s) {
		for (var i = 0; i < s.length; i++) {
			bytes.push (s.charCodeAt (i));
		}
	}

	var bytes = [];

	serializeShort (0xFFD8, true); // SOI marker
	serializeShort (0xFFE1, true); // APP1 marker
	serializeShort (0x0000, true); // APP1 size FIXME
	serializeAscii ('Exif'); // Exif
	serializeShort (0x0000, true);
	if (bigEndian) {
		serializeAscii ('MM');
	} else {
		serializeAscii ('II');
	}
	serializeShort (0x2A, bigEndian);
	serializeLong (0x8, bigEndian);

	var exC = n1.length * 12 + 14;
	var exD = '';
	serializeShort (n1.length, bigEndian);
	for (var e in n1) {
		if (e == 'length') continue;

		serializeShort (parseInt (e, 16), bigEndian);
		serializeShort (n1 [e].type, bigEndian);
		serializeLong (n1 [e].count, bigEndian);
		if (n1 [e].type == 2) {
			serializeLong (exC, bigEndian);
			exD += n1 [e].str + '\0';
			exC += n1 [e].count;
		} else if (e == '8769') {
			serializeLong (exC, bigEndian);
		} else {
			serializeLong (n1 [e].value, bigEndian);
		}
	}
	serializeLong (0, bigEndian);
	serializeAscii (exD);

	exC += n2.length * 12 + 6;
	exD = '';
	serializeShort (n2.length, bigEndian);
	for (var e in n2) {
		if (e == 'length') continue;

		serializeShort (parseInt (e, 16), bigEndian);
		serializeShort (n2 [e].type, bigEndian);
		serializeLong (n2 [e].count, bigEndian);
		switch (n2 [e].type) {
		case 2:
			serializeLong (exC, bigEndian);
			exD += n2 [e].str + '\0';
			exC += n2 [e].count;
			break;
		case 5:
		case 10:
		case 12:
			serializeLong (exC, bigEndian);
			exD += n2 [e].str;
			exC += 8;
			break;
		default:
			serializeLong (n2 [e].value, bigEndian);
			break;
		}
	}
	serializeLong (0, bigEndian);
	serializeAscii (exD);

	var length = exC + 8;
	bytes [4] = (length & 0xff00) >> 8;
	bytes [5] = length & 0x00ff;

	var string = '';
	for (var i = 0; i < bytes.length; i++) {
		string += String.fromCharCode (bytes [i]);
	}
	return string;
}
*/
var image = new Image ();
image.onload = function () {
	var c = createCanvas (this, 600, 600, Exif.orientation);

	var stream = Cc ["@mozilla.org/network/safe-file-output-stream;1"].createInstance (Ci.nsIFileOutputStream);
	stream.init (destFile, 0x04 | 0x08 | 0x20, 0600, 0); // write, create, truncate
	var bStream = Cc ["@mozilla.org/binaryoutputstream;1"].createInstance (Ci.nsIBinaryOutputStream);
	bStream.setOutputStream (stream);

document.body.appendChild (c);
	var str = c.toDataURL ('image/jpeg', 'quality=70');
	str = str.substring (23);
	var bytes = atob (str);

	if (Exif.block1) {
		Exif.block2 ['a002'].value = c.width;
		Exif.block2 ['a003'].value = c.height;
var a = 0;
for (var e in Exif.block2) {
	document.body.appendChild (document.createElement ('br'));
	document.body.appendChild (document.createTextNode (e + ': ' + JSON.stringify (Exif.block2 [e])));
	a++;
}
document.body.appendChild (document.createElement ('br'));
//Exif.block2.length = a;
		Exif.serialize ();
//Exif.sBytes [5] = 0x46;
writeHex (Exif.sBytes);
		bStream.writeByteArray (Exif.sBytes, Exif.sBytes.length);
		var offset = bytes.charCodeAt (4) * 256 + bytes.charCodeAt (5) + 4;
		bytes = bytes.substring (offset);
	}

	bStream.writeBytes (bytes, bytes.length);
	if (stream instanceof Ci.nsISafeOutputStream) {
		stream.finish ();
	} else {
		stream.close ();
	}
}

var ioService = Cc ['@mozilla.org/network/io-service;1'].getService (Ci.nsIIOService);
image.src = ioService.newFileURI (sourceFile).spec;

function createCanvas(image, maxWidth, maxHeight, rotation) {
	var ratio = Math.min (1, Math.min (maxWidth / image.width, maxHeight / image.height));
	if (ratio >= 1) {
		return image;
	}

	var canvas = document.createElementNS ("http://www.w3.org/1999/xhtml", "canvas");
	var context = canvas.getContext("2d");

	var scaledWidth = Math.floor (image.width * ratio + 0.025);
	var scaledHeight = Math.floor (image.height * ratio + 0.025);

	switch (rotation) {
	case 0:
		canvas.width = scaledWidth;
		canvas.height = scaledHeight;
		break;
	case 90:
		canvas.width = scaledHeight;
		canvas.height = scaledWidth;
		context.translate (0, scaledWidth);
		context.rotate (-0.5 * Math.PI);
		break;
	case 180:
		canvas.width = scaledWidth;
		canvas.height = scaledHeight;
		context.translate (scaledWidth, scaledHeight);
		context.rotate (Math.PI);
		break;
	case 270:
		canvas.width = scaledHeight;
		canvas.height = scaledWidth;
		context.translate (scaledHeight, 0);
		context.rotate (0.5 * Math.PI);
		break;
	}

	context.scale(ratio, ratio);
	context.drawImage(image, 0, 0);

	return canvas;
}

</script>
</body>

</html>
